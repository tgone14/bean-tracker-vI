<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bean - Dialysis Tracker</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3594/3594041.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .bean-gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .progress-bar-bg { background-color: #e5e7eb; border-radius: 9999px; height: 1.2rem; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.5s ease-in-out; }
        input, select { font-size: 16px !important; } 
        .search-results { max-height: 250px; overflow-y: auto; z-index: 50; }
        
        /* Traffic Light Colors */
        .k-green { background-color: #dcfce7; color: #166534; border-left: 4px solid #22c55e; }
        .k-yellow { background-color: #fef9c3; color: #854d0e; border-left: 4px solid #eab308; }
        .k-red { background-color: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
        .pill-green { background: #22c55e; color: white; }
        .pill-yellow { background: #eab308; color: white; }
        .pill-red { background: #ef4444; color: white; }
    </style>
</head>
<body class="pb-24">

    <header class="bean-gradient text-white p-6 shadow-lg rounded-b-3xl mb-4 text-center">
        <h1 class="text-3xl font-bold text-white">Bean</h1>
        <p class="text-sm opacity-90 text-white" id="current-date"></p>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-6">

        <section class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-lg font-bold text-gray-700">Net Daily Intake</h2>
                <button onclick="exportData()" class="text-xs bg-blue-100 text-blue-600 px-3 py-1 rounded-full font-bold">üìÑ Export</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-medium text-gray-600">Potassium (K)</span>
                        <span class="font-bold text-gray-800"><span id="total-k">0</span> / <span id="disp-limit-k">2000</span> mg</span>
                    </div>
                    <div class="progress-bar-bg"><div id="bar-k" class="progress-fill bg-blue-500" style="width: 0%"></div></div>
                </div>
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-medium text-gray-600">Net Phosphorus (P)</span>
                        <span class="font-bold text-gray-800"><span id="total-p">0</span> / <span id="disp-limit-p">1000</span> mg</span>
                    </div>
                    <div class="progress-bar-bg"><div id="bar-p" class="progress-fill bg-purple-500" style="width: 0%"></div></div>
                </div>
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-medium text-gray-600">Fluid</span>
                        <span class="font-bold text-gray-800"><span id="total-f">0</span> / <span id="disp-limit-f">1000</span> ml</span>
                    </div>
                    <div class="progress-bar-bg"><div id="bar-f" class="progress-fill bg-teal-400" style="width: 0%"></div></div>
                </div>
            </div>
        </section>

        <div class="flex space-x-1 bg-gray-200 p-1 rounded-xl">
            <button onclick="switchTab('food')" id="tab-food" class="flex-1 py-2 rounded-lg font-bold text-sm bg-white shadow text-gray-800">üçé Food</button>
            <button onclick="switchTab('binder')" id="tab-binder" class="flex-1 py-2 rounded-lg font-bold text-sm text-gray-500">üíä Binder</button>
            <button onclick="switchTab('history')" id="tab-history" class="flex-1 py-2 rounded-lg font-bold text-sm text-gray-500">üìú History</button>
        </div>

        <section id="section-food" class="bg-white p-5 rounded-2xl shadow-sm space-y-3">
            <div class="relative">
                <input type="text" id="food-search" placeholder="Quick Search..." 
                    class="w-full p-3 bg-gray-50 border rounded-xl focus:ring-2 focus:ring-purple-400 outline-none"
                    oninput="searchFood(this.value)">
                <div id="search-results" class="search-results hidden absolute z-10 w-full bg-white border rounded-xl mt-1 shadow-2xl"></div>
            </div>
            
            <div class="text-center text-[10px] text-gray-300 font-bold uppercase tracking-widest">or browse categories</div>
            
            <select id="category-select" class="w-full p-3 bg-gray-50 border rounded-xl text-sm" onchange="renderCategoryItems(this.value)">
                <option value="" disabled selected>Tap to Choose Category</option>
            </select>
            
            <div id="category-items-list" class="space-y-2 mt-2 max-h-64 overflow-y-auto hidden">
                </div>
        </section>

        <section id="section-binder" class="hidden bg-white p-5 rounded-2xl shadow-sm border-l-4 border-green-400">
            <div class="space-y-4 text-center">
                <select id="binder-select" class="w-full p-3 bg-gray-50 border rounded-xl text-sm" onchange="checkBinderEnable()">
                    <option value="" disabled selected>Select Binder</option>
                </select>
                
                <div class="flex items-center justify-center space-x-6 py-2">
                    <button onclick="changeQty(-1)" class="w-12 h-12 rounded-full border-2 border-green-500 text-green-500 text-2xl font-bold flex items-center justify-center active:bg-green-100">-</button>
                    <span id="binder-qty-display" class="text-3xl font-black text-gray-700 w-8">1</span>
                    <button onclick="changeQty(1)" class="w-12 h-12 rounded-full border-2 border-green-500 text-green-500 text-2xl font-bold flex items-center justify-center active:bg-green-100">+</button>
                </div>

                <button onclick="addBinder()" id="add-binder-btn" class="w-full bg-green-600 text-white font-bold py-4 rounded-xl disabled:opacity-50" disabled>Add <span id="btn-qty-label">1</span> Binder(s)</button>
            </div>
        </section>

        <section id="section-history" class="hidden space-y-3">
            <h2 class="text-gray-600 font-bold px-1 text-center">Past 7 Days</h2>
            <div id="history-list" class="space-y-2"></div>
        </section>

        <section id="section-log">
            <div class="flex justify-between items-center mb-3 px-1">
                <h2 class="text-lg font-semibold text-gray-700">Today's Entries</h2>
                <button onclick="clearToday()" class="text-xs text-red-400 font-bold uppercase">Reset</button>
            </div>
            <ul id="log-list" class="space-y-2"></ul>
        </section>

        <details class="bg-gray-100 p-4 rounded-xl">
            <summary class="text-sm font-bold text-gray-500 cursor-pointer">‚öôÔ∏è Settings & Limits</summary>
            <div class="grid grid-cols-3 gap-2 mt-3 text-center">
                <div><label class="text-[9px] font-bold text-gray-400 uppercase">K (mg)</label><input type="number" id="limit-k" class="w-full p-2 border rounded-lg text-sm" onchange="saveSettings()"></div>
                <div><label class="text-[9px] font-bold text-gray-400 uppercase">P (mg)</label><input type="number" id="limit-p" class="w-full p-2 border rounded-lg text-sm" onchange="saveSettings()"></div>
                <div><label class="text-[9px] font-bold text-gray-400 uppercase">Fluid (mL)</label><input type="number" id="limit-f" class="w-full p-2 border rounded-lg text-sm" onchange="saveSettings()"></div>
            </div>
        </details>
    </main>

    <script>
        const foodDatabase = {
            "Fruits": [{ name: "Apple", k: 195, p: 20, f: 0 }, { name: "Banana", k: 422, p: 26, f: 0 }, { name: "Grapes (1c)", k: 288, p: 30, f: 0 }, { name: "Watermelon (1c)", k: 170, p: 15, f: 140 }, { name: "Blueberries (1c)", k: 114, p: 18, f: 0 }, { name: "Strawberries (1c)", k: 230, p: 35, f: 0 }],
            "Vegetables": [{ name: "Carrots", k: 180, p: 24, f: 0 }, { name: "Potato (Med)", k: 926, p: 121, f: 0 }, { name: "Green Beans", k: 90, p: 19, f: 0 }, { name: "Cucumber", k: 140, p: 20, f: 50 }, { name: "Broccoli (1c)", k: 290, p: 60, f: 0 }],
            "Proteins": [{ name: "Chicken (3oz)", k: 220, p: 196, f: 0 }, { name: "Egg (1)", k: 69, p: 95, f: 0 }, { name: "Salmon (3oz)", k: 326, p: 214, f: 0 }, { name: "Beef (3oz)", k: 270, p: 200, f: 0 }, { name: "Tofu (1/2c)", k: 120, p: 120, f: 0 }],
            "Dairy/Grains": [{ name: "Milk (1c)", k: 366, p: 232, f: 240 }, { name: "Rice (1c)", k: 55, p: 68, f: 0 }, { name: "White Bread", k: 30, p: 30, f: 0 }, { name: "Pasta (1c)", k: 60, p: 80, f: 0 }],
            "Beverages": [{ name: "Water (8oz)", k: 0, p: 0, f: 240 }, { name: "Coffee (8oz)", k: 116, p: 7, f: 240 }, { name: "Cola (12oz)", k: 0, p: 40, f: 355 }, { name: "Tea (8oz)", k: 88, p: 0, f: 240 }, { name: "Orange Juice (8oz)", k: 496, p: 44, f: 240 }]
        };

        const binderDatabase = [
            { name: "Calcium Carbonate (500mg)", bind: 19 }, { name: "Calcium Acetate (667mg)", bind: 30 },
            { name: "Sevelamer HCl (800mg)", bind: 17 }, { name: "Lanthanum (500mg)", bind: 45 },
            { name: "Lanthanum (750mg)", bind: 68 }, { name: "Velphoro (500mg)", bind: 130 }
        ];

        let dailyLog = JSON.parse(localStorage.getItem('bean_log')) || [];
        let limits = JSON.parse(localStorage.getItem('bean_limits')) || { k: 2000, p: 1000, f: 1000 };
        let history = JSON.parse(localStorage.getItem('bean_history')) || {};
        let binderQty = 1;
        const todayKey = new Date().toISOString


